# name: test/sql/upsert/upsert_explicit_index.test
# group: [upsert]

statement ok
pragma enable_verification;

# ---- With unique index -----

statement ok
create table tbl (i integer, j integer);

statement ok
insert into tbl values (5,3), (3,2);

statement ok
create unique index my_index on tbl(i);

statement ok
insert into tbl values (5,2) on conflict (i) do update set j = 10;

query II
select * from tbl;
----
5	10
3	2

statement ok
drop table tbl cascade;

# ---- With non-unique index -----

statement ok
create table tbl (
	i integer primary key,
	j integer
);

statement ok
create index idx1 on tbl(j);

statement ok
insert into tbl values (10,2);

statement ok
insert into tbl values (10,2) on conflict do update set j = 3;

query II
select * from tbl;
----
10	3

statement ok
drop table tbl cascade;

statement ok
create table tbl (
	i integer primary key,
	j integer
);

statement ok
create index idx1 on tbl(j);

statement ok
insert into tbl values (10,2);

statement ok
insert into tbl values (10,2) on conflict do update set j = 3;

query II
select * from tbl;
----
10	3

statement ok
insert into tbl values (11,3) on conflict do update set j = 5;

query II
select * from tbl;
----
10	3
11	3

statement ok
drop table tbl cascade;

# ---- With unique and non-unique index -----

statement ok
create table tbl (
	i integer primary key,
	j integer,
	k integer,
);

statement ok
create index idx1 on tbl(j);

statement ok
create unique index idx2 on tbl(k);

statement ok
insert into tbl values (3, 2, 1)

statement error
insert into tbl values (3, 2, 1) on conflict do update set j = 2;
----
Conflict target has to be provided for a DO UPDATE operation when the table has multiple UNIQUE/PRIMARY KEY constraints

statement error
insert into tbl values (3, 2, 1) on conflict (j) do update set j = 2;
----
The specified columns as conflict target are not referenced by a UNIQUE/PRIMARY KEY CONSTRAINT

statement error
insert into tbl values (3, 2, 1) on conflict (k) do update set k = 1;
----
Can not assign to column 'k' because it has a UNIQUE/PRIMARY KEY constraint

statement ok
insert into tbl values (3, 2, 1) on conflict (k) do update set j = 2;

query III
select * from tbl;
----
3	2	1
