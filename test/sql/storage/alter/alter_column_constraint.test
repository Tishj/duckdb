# name: test/sql/storage/alter/alter_column_constraint.test
# description: Issue #1785: ALTER TABLE causes constraints lost in database file after exiting
# group: [alter]

# load the DB from disk
load __TEST_DIR__/add_column_constraint.db

statement ok
CREATE TABLE IF NOT EXISTS a(id INT PRIMARY KEY);

statement ok
INSERT INTO a(id) VALUES (1);

# add column
statement ok
ALTER TABLE a ADD COLUMN c REAL;

statement error
INSERT INTO a(id) VALUES (1);
----
Constraint Error: Duplicate key "id: 1" violates primary key constraint. If this is an unexpected constraint violation please double check with the known index limitations section in our documentation (docs - sql - indexes).

restart

statement error
INSERT INTO a(id) VALUES (1);
----
Constraint Error: Duplicate key "id: 1" violates primary key constraint. If this is an unexpected constraint violation please double check with the known index limitations section in our documentation (docs - sql - indexes).

# add default
statement ok
ALTER TABLE a ALTER COLUMN c SET DEFAULT 10;

statement error
INSERT INTO a(id) VALUES (1);
----
Constraint Error: Duplicate key "id: 1" violates primary key constraint. If this is an unexpected constraint violation please double check with the known index limitations section in our documentation (docs - sql - indexes).

restart

statement error
INSERT INTO a(id) VALUES (1);
----
Constraint Error: Duplicate key "id: 1" violates primary key constraint. If this is an unexpected constraint violation please double check with the known index limitations section in our documentation (docs - sql - indexes).

# rename column
statement ok
ALTER TABLE a RENAME c TO d;

statement error
INSERT INTO a(id) VALUES (1);
----
Constraint Error: Duplicate key "id: 1" violates primary key constraint. If this is an unexpected constraint violation please double check with the known index limitations section in our documentation (docs - sql - indexes).

restart

statement error
INSERT INTO a(id) VALUES (1);
----
PLACEHOLDER_ERROR_MESSAGE2567

# rename table
statement ok
ALTER TABLE a RENAME TO b;

statement error
INSERT INTO b(id) VALUES (1);
----
PLACEHOLDER_ERROR_MESSAGE2566

restart

statement error
INSERT INTO b(id) VALUES (1);
----
PLACEHOLDER_ERROR_MESSAGE2565

# drop column
statement ok
ALTER TABLE b DROP d;

statement error
INSERT INTO b(id) VALUES (1);
----
PLACEHOLDER_ERROR_MESSAGE2564

restart

statement error
INSERT INTO b(id) VALUES (1);
----
PLACEHOLDER_ERROR_MESSAGE2563

statement ok
INSERT INTO b(id) VALUES (2);