# name: test/sql/catalog/function/test_simple_macro.test
# description: Test Simple Macro
# group: [function]

statement ok
PRAGMA enable_verification

statement ok
CREATE TABLE integers (a INT)

statement ok
INSERT INTO integers VALUES (1)

statement ok
CREATE MACRO one() AS (SELECT 1);

query T
SELECT one()
----
1

statement error
SELECT one(1)
----
Binder Error: Macro function 'one()' requires 0 positional arguments, but a single positional argument was provided.

statement error
SELECT one(NULL)
----
Binder Error: Macro function 'one()' requires 0 positional arguments, but a single positional argument was provided.

statement ok
DROP MACRO one;

# HAVING in a macro
statement ok
CREATE MACRO having_macro(x) AS (SELECT * FROM integers GROUP BY a HAVING a = x)

query T
SELECT having_macro(1)
----
1

query T
SELECT having_macro(6)
----
NULL

# UNION in a macro
statement ok
CREATE MACRO union_macro(x, y, z) AS (SELECT x IN (SELECT y UNION ALL SELECT z))

query T
SELECT union_macro(1, 2, 3)
----
false

query T
SELECT union_macro(1, 2, 1)
----
true

query T
SELECT union_macro(1, 1, 2)
----
true

# expression list
statement ok
CREATE MACRO in_expression_list(x, y, z) AS (SELECT x IN (VALUES (y), (z)))

query T
SELECT in_expression_list(1, 2, 3)
----
false

query T
SELECT in_expression_list(1, 2, 1)
----
true

query T
SELECT in_expression_list(1, 1, 2)
----
true

# FUNCTION alias
statement ok
CREATE FUNCTION two() AS (SELECT 2);

query T
SELECT two()
----
2

statement ok
DROP FUNCTION two;

# b cannot be found
statement error
CREATE MACRO add_macro(a) AS a + b
----
Binder Error: Referenced column "b" not found in FROM clause!

statement ok
CREATE MACRO add_macro(a, b) AS a + b

query T
SELECT add_macro(a,a) FROM integers
----
2

statement ok
CREATE TABLE floats (b FLOAT)

statement ok
INSERT INTO floats VALUES (0.5)

query T
SELECT add_macro(a,2) + add_macro(3,b) FROM integers, floats
----
6.5

# can create function with same name as a ScalarFunction
statement ok
CREATE MACRO string_split(a,b) AS a + b

query I
SELECT string_split(1, 2)
----
3

statement ok
CREATE MACRO IFELSE(a,b,c) AS CASE WHEN a THEN b ELSE c END

query T
SELECT IFELSE(1,'true','false')
----
true

query T
SELECT ifelse(1,'true','false')
----
true

query T
SELECT IFELSE(0,'true','false')
----
false

query T
SELECT IFELSE(a = 1, 'true', 'false') FROM integers
----
true

query T
SELECT IFELSE(a = 0, 'true', 'false') FROM integers
----
false

# incorrect number of arguments
statement error
SELECT IFELSE();
----
Binder Error: Macro function 'IFELSE(a, b, c)' requires 3 positional arguments, but 0 positional arguments were provided.

statement error
SELECT IFELSE(1);
----
Binder Error: Macro function 'IFELSE(a, b, c)' requires 3 positional arguments, but a single positional argument was provided.

statement error
SELECT IFELSE(1, 2);
----
Binder Error: Macro function 'IFELSE(a, b, c)' requires 3 positional arguments, but 2 positional arguments were provided.

statement error
SELECT IFELSE(1, 2, 3, 4);
----
Binder Error: Macro function 'IFELSE(a, b, c)' requires 3 positional arguments, but 4 positional arguments were provided.

# no duplicate macro function names
statement error
CREATE MACRO IFELSE(a,b) AS a+b
----
Catalog Error: Macro Function with name "IFELSE" already exists!

statement error
CREATE MACRO ifelse(a,b) AS a+b
----
Catalog Error: Macro Function with name "ifelse" already exists!

query T
SELECT IFELSE(1, 'random', RANDOM())
----
random

# macro in a different schema
statement ok
CREATE SCHEMA macros

statement ok
CREATE MACRO macros.add_macro(a, b) AS a + b

query T
SELECT macros.add_macro(40,2)
----
42

# conflicting parameter names in macro definition
statement error
CREATE MACRO conflict(i, i) AS i + 1
----
Binder Error: table "0_macro_parametersconflict" has duplicate column name "i"

# aggregation macro's
statement ok
CREATE MACRO myavg(x) AS SUM(x) / COUNT(x)

statement ok
INSERT INTO integers VALUES (21), (41);

query T
SELECT myavg(a) FROM integers
----
21

statement ok
CREATE MACRO weird_avg(x) AS (MIN(x) + MAX(x)) / COUNT(x)

query T
SELECT weird_avg(a) FROM integers
----
14

statement error
CREATE MACRO star() AS *
----
Binder Error: STAR expression is not supported here

# macro's with default arguments
statement error
CREATE MACRO conflict(a, a := 1) AS a + a
----
Binder Error: table "0_macro_parametersconflict" has duplicate column name "a"

statement ok
CREATE MACRO add_default5(a, b := 5) AS a + b

statement error
SELECT add_default5(3, 6)
----
Binder Error: Macro function 'add_default5(a)' requires a single positional argument, but 2 positional arguments were provided.

query T
SELECT add_default5(3)
----
8

query T
SELECT add_default5(3, b := 6)
----
9

statement error
SELECT add_default5(b := 6, 3)
----
Binder Error: Positional parameters cannot come after parameters with a default value!

statement error
CREATE MACRO wrong_order(a, b := 3, c)
----
Parser Error: syntax error at end of input

statement error
CREATE MACRO wrong_order(a := 3, b)
----
Parser Error: syntax error at end of input

# only constant default values are allowed
statement error
CREATE MACRO select_plus_floats(a, f := b) AS (SELECT a + f FROM floats)
----
Binder Error: Referenced column "f" not found in FROM clause!
Candidate bindings: "floats.b"

# +(FLOAT, VARCHAR) does not work - constant types are checked at create time
statement error
CREATE MACRO wrong_type(s='not a float') AS (SELECT b + s FROM floats)
----
Parser Error: Invalid parameter: '(s = 'not a float')'

statement error
CREATE MACRO two_default_params(a := 4, a := 2) AS a + a
----
Parser Error: Duplicate default parameter: 'a'

statement ok
CREATE MACRO two_default_params(a := 4, b := 2) AS a + b

query T
SELECT two_default_params()
----
6

query T
SELECT two_default_params(a := 5)
----
7

query T
SELECT two_default_params(b := 3)
----
7

statement error
SELECT two_default_params(a := 5, a := 3)
----
Binder Error: Duplicate default parameters a!

statement error
SELECT two_default_params(b := 5, b := 3)
----
Binder Error: Duplicate default parameters b!

statement error
CREATE MACRO macros.add_macro(a, b) AS a + b
----
Catalog Error: Macro Function with name "add_macro" already exists!

statement error
CREATE MACRO my_macro(a.b) AS 42;
----
Binder Error: Invalid parameter name 'a.b': must be unqualified

statement error
CREATE MACRO my_macro(a.b.c) AS 42;
----
PLACEHOLDER_ERROR_MESSAGE1823

statement ok
CREATE MACRO my_macro(a) AS 42;

statement error
SELECT my_macro(x := 42);
----
PLACEHOLDER_ERROR_MESSAGE1822

statement error
SELECT my_macro(a := 42, a := 42);
----
PLACEHOLDER_ERROR_MESSAGE1821
