# name: test/sql/constraints/foreignkey/test_fk_multiple.test
# description: Test multiple foreign key constraint
# group: [foreignkey]

statement ok
CREATE TABLE pkt1(i1 INTEGER PRIMARY KEY CHECK(i1 < 3), j1 INTEGER UNIQUE);

statement ok
CREATE TABLE pkt2(i2 INTEGER PRIMARY KEY, j2 INTEGER UNIQUE CHECK (j2 > 1000));

statement ok
CREATE TABLE fkt1(k1 INTEGER, l1 INTEGER, FOREIGN KEY(k1) REFERENCES pkt1(i1), FOREIGN KEY(l1) REFERENCES pkt2(i2));

statement ok
CREATE TABLE fkt2(k2 INTEGER, l2 INTEGER, FOREIGN KEY(k2) REFERENCES pkt1(j1), FOREIGN KEY(l2) REFERENCES pkt2(j2));

# ensure the constraints are being correctly copied
statement error
INSERT INTO pkt1 VALUES (3, 11);
----
Constraint Error: CHECK constraint failed: pkt1

statement error
INSERT INTO pkt2 VALUES (101, 1000);
----
Constraint Error: CHECK constraint failed: pkt2

# test multiple foreign key constraints
statement ok
INSERT INTO pkt1 VALUES (1, 11), (2, 12);

statement ok
INSERT INTO pkt2 VALUES (101, 1001), (102, 1002);

statement error
INSERT INTO fkt1 VALUES (3, 101);
----
Constraint Error: Violates foreign key constraint because key "i1: 3" does not exist in the referenced table

statement error
INSERT INTO fkt1 VALUES (2, 103);
----
Constraint Error: Violates foreign key constraint because key "i2: 103" does not exist in the referenced table

statement ok
INSERT INTO fkt1 VALUES (1, 102), (2, 101);

statement error
INSERT INTO fkt2 VALUES (13, 1002);
----
Constraint Error: Violates foreign key constraint because key "j1: 13" does not exist in the referenced table

statement error
INSERT INTO fkt1 VALUES (12, 1003);
----
Constraint Error: Violates foreign key constraint because key "i1: 12" does not exist in the referenced table

statement ok
INSERT INTO fkt2 VALUES (12, 1001), (11, 1002);

statement error
DELETE FROM pkt1 WHERE i1=1
----
Constraint Error: Violates foreign key constraint because key "k1: 1" is still referenced by a foreign key in a different table

statement error
DELETE FROM pkt2 WHERE i2=102
----
Constraint Error: Violates foreign key constraint because key "l1: 102" is still referenced by a foreign key in a different table

statement ok
DELETE FROM fkt1 WHERE k1=1

statement error
DELETE FROM pkt1 WHERE i1=1
----
PLACEHOLDER_ERROR_MESSAGE1360

statement ok
DELETE FROM fkt2 WHERE k2=11

statement ok
DELETE FROM pkt1 WHERE i1=1

query II
SELECT * FROM pkt1;
----
2	12	

query II
SELECT * FROM pkt2;
----
101	1001	
102	1002	

query II
SELECT * FROM fkt1;
----
2	101	

query II
SELECT * FROM fkt2;
----
12	1001	

statement error
UPDATE pkt1 SET i1=3, j1=13 WHERE i1=2;
----
PLACEHOLDER_ERROR_MESSAGE1359

statement error
UPDATE pkt2 SET i2=103, j2=1003 WHERE i2=101;
----
PLACEHOLDER_ERROR_MESSAGE1358

statement ok
UPDATE pkt2 SET i2=103, j2=1003 WHERE i2=102;

statement ok
DELETE FROM fkt1 WHERE k1=2

statement ok
DELETE FROM fkt2 WHERE k2=12

statement ok
UPDATE pkt1 SET i1=1, j1=11 WHERE i1=2;

statement ok
UPDATE pkt2 SET i2=104, j2=1004 WHERE i2=101;

query II
SELECT * FROM pkt1;
----
1	11	

query II
SELECT * FROM pkt2;
----
103	1003	
104	1004	

statement error
DROP TABLE pkt1
----
PLACEHOLDER_ERROR_MESSAGE1357

statement error
DROP TABLE pkt2
----
PLACEHOLDER_ERROR_MESSAGE1356

statement ok
DROP TABLE fkt2

statement error
DROP TABLE pkt1
----
PLACEHOLDER_ERROR_MESSAGE1355

statement error
DROP TABLE pkt2
----
PLACEHOLDER_ERROR_MESSAGE1354

statement ok
DROP TABLE fkt1

statement ok
DROP TABLE pkt1

statement ok
DROP TABLE pkt2
