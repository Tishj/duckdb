# name: test/sql/types/list/unnest_table_function.test
# description: Test UNNEST in a table function
# group: [list]

statement ok
PRAGMA enable_verification

# standard usage of unnest
query I
SELECT * FROM UNNEST(ARRAY[1, 2, 3])
----
1
2
3

query I
SELECT * FROM UNNEST([1, 2, 3]::INT ARRAY)
----
1
2
3

query I
SELECT i FROM UNNEST(ARRAY[1, 2, 3]) AS tbl(i)
----
1
2
3

# string
query I
SELECT i FROM UNNEST(ARRAY[NULL, 'hello', 'world', 'bleorkbaejkoreijgaiorjgare']) AS tbl(i)
----
NULL
hello
world
bleorkbaejkoreijgaiorjgare

# list
query I
SELECT i FROM UNNEST([[1, 2], [3, 4], NULL, [4, 5, 6, 7]]) AS tbl(i)
----
[1, 2]
[3, 4]
NULL
[4, 5, 6, 7]

# nested nested
query I
SELECT i FROM UNNEST([{'a': [1, 2, 3], 'b': [4, 5, 6]}, {'a': [4, 5], 'b': [7, 8, 9, 10]}]) AS tbl(i)
----
{'a': [1, 2, 3], 'b': [4, 5, 6]}
{'a': [4, 5], 'b': [7, 8, 9, 10]}

# > vector size
query I
SELECT COUNT(*) FROM UNNEST([x for x in range(2049)]) AS tbl(i)
----
2049

# null
query I
SELECT i FROM UNNEST(NULL::INT[]) AS tbl(i)
----

# empty list
query I
SELECT i FROM UNNEST([]::INT[]) AS tbl(i)
----

# unnest from a subquery
query I
SELECT * FROM UNNEST((SELECT [1,2,3] UNION ALL SELECT [4,5]))
----
1
2
3
4
5

statement ok
CREATE TABLE lists AS SELECT [1,2,3] l UNION ALL SELECT [4,5] UNION ALL SELECT [] UNION ALL SELECT [NULL] UNION ALL SELECT [7, 8]

query I
SELECT * FROM UNNEST((SELECT l FROM lists))
----
1
2
3
4
5
NULL
7
8

# unnest with a prepared statement parameter
statement ok
PREPARE v1 AS SELECT * FROM UNNEST(?::INT[]);

query I
EXECUTE v1([1,2,3,4,5]);
----
1
2
3
4
5

# null without cast (should this work?)
statement error
SELECT i FROM UNNEST(NULL) AS tbl(i)

# not a list
statement error
SELECT i FROM UNNEST(1) AS tbl(i)

# multiple parameters
statement error
SELECT i FROM UNNEST([1, 2], [3, 4]) AS tbl(i)
