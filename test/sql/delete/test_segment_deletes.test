# name: test/sql/delete/test_segment_deletes.test
# description: Test deletions
# group: [delete]

require skip_reload

statement ok con1
CREATE TABLE a(i INTEGER);

# insert the values [0, 1, 2, .. 2046, 2047] repeatedly
# however, make sure the order that we insert them is 
loop i 0 20

statement ok con1
INSERT INTO a SELECT * FROM range(0, 2048, 1);

endloop

# verify the count

query I con1
SELECT COUNT(*) FROM a
----
40960

# we test the values 0, 1, 2046 and 2047
# for every tested value, delete it and then rollback

# value = 0
statement ok con1
BEGIN TRANSACTION;
DELETE FROM a WHERE i=0;

# verify the deleted count
query I con1
SELECT COUNT(*) FROM a
----
40940

statement ok con1
ROLLBACK

# verify the initial count
query I con1
SELECT COUNT(*) FROM a
----
40960

# value = 1
statement ok con1
BEGIN TRANSACTION;
DELETE FROM a WHERE i=1;

# verify the deleted count
query I con1
SELECT COUNT(*) FROM a
----
40940

statement ok con1
ROLLBACK

# verify the initial count
query I con1
SELECT COUNT(*) FROM a
----
40960

# value = 2046
statement ok con1
BEGIN TRANSACTION;
DELETE FROM a WHERE i=2046;

# verify the deleted count
query I con1
SELECT COUNT(*) FROM a
----
40940

statement ok con1
ROLLBACK

# verify the initial count
query I con1
SELECT COUNT(*) FROM a
----
40960

# value = 1023
statement ok con1
BEGIN TRANSACTION;
DELETE FROM a WHERE i=2047;

# verify the deleted count
query I con1
SELECT COUNT(*) FROM a
----
40940

statement ok con1
ROLLBACK

# verify the initial count
query I con1
SELECT COUNT(*) FROM a
----
40960

# now, for every tested value, delete it in a separate connection and verify the count
# con2 -> 0
statement ok con2
BEGIN TRANSACTION;

statement ok con2
DELETE FROM a WHERE i=0;

query I con2
SELECT COUNT(*) FROM a;
----
40940

# con3 -> 1
statement ok con3
BEGIN TRANSACTION;

statement ok con3
DELETE FROM a WHERE i=1;

query I con3
SELECT COUNT(*) FROM a;
----
40940

# con4 -> 2046
statement ok con4
BEGIN TRANSACTION;

statement ok con4
DELETE FROM a WHERE i=2046;

query I con4
SELECT COUNT(*) FROM a;
----
40940

# con5 -> 2047
statement ok con5
BEGIN TRANSACTION;

statement ok con5
DELETE FROM a WHERE i=2047;

query I con5
SELECT COUNT(*) FROM a;
----
40940

# con1 still has the original count
query I con1
SELECT COUNT(*) FROM a;
----
40960

# until we update the other transactions
statement ok con2
COMMIT

statement ok con3
COMMIT

statement ok con4
COMMIT

statement ok con5
COMMIT

# now the count is updated
query I con1
SELECT COUNT(*) FROM a;
----
40880